#!/bin/sh
set -e; set -u

_O_busybox_src=$HOME/src/busybox
_O_f8ksh_dir=$HOME/src/f8ksh
_O_setup_shells=true _O_runs=48

benchmark() {
  local "$@"
  rm -f /tmp/fakesh.log

  local cmdlog; cmdlog=$("$_O_f8ksh_dir"/util/logcmdname --fmt='cmdlog-$CMD' -- hyperfine -w 2 -r $_O_runs -s basic \
    "KAKOUNE_POSIX_SHELL=\"$KAKOUNE_POSIX_SHELL\" PATH=\"${PPATH:+$PPATH:}\$PATH\" $CMD")
  sed -i -e '1s@\&>.*@@' "$cmdlog"
  mv "$cmdlog" logs/
  test -r /tmp/fakesh.log || return 0
  ls -al /tmp/fakesh.log
  local log=logs/"$(s=${KAKOUNE_POSIX_SHELL%/fakesh.sh}; echo "${s##*/}")${PPATH:+_PPATH}${BMSFX:+_$BMSFX}"_fakesh.log
  mv /tmp/fakesh.log "$log"
  $static_sh ~/Projects/f8ksh/fakesh-log-conv --logfunc=2sql <"$log" | sqlite3 "${log%.log}.sqlite3"
  zstd --rm "$log"
}

setup_shells() {
  MAKEFLAGS=-j8 "$_O_f8ksh_dir"/setup-bbox --clear --busybox=make --busybox-src="$_O_busybox_src" --busybox-config-nofork /tmp/bbox-builtin+nofork
  MAKEFLAGS=-j8 "$_O_f8ksh_dir"/setup-bbox --clear --busybox=make --busybox-src="$_O_busybox_src" /tmp/bbox-builtin
# "$_O_f8ksh_dir"/setup-bbox --clear --busybox=debian /tmp/bbox-deb
  "$_O_f8ksh_dir"/setup-bbox --clear --busybox=alpine /tmp/bbox+ln
}

# adapted min-template.sh (https://git@gitlab/kstr0k/bashaaparse)
__usage() {  # args: header footer
  local flags
  flags=$(set | sed -ne 's/^_O_\([^=]\+\)=.*/\1/p')
  printf '%s'${1:+'\n'}  "${1:-}"  # add \n only if missing
  test -z "$flags" || printf -- '--%s=ARG\n'  $(printf '%s'  "$flags" | sed -e 's/_/-/g')
  printf '%s'${2:+'\n'}  "${2:-}"
}
__parse_args() {
  local k
  test $# -gt 0 || set -- --
  if ! __process_arg "$@"; then
    case "$1" in
      -v) set -x ;;
      -h|--help|--usage|-'?') __usage 'Options:'; exit 0 ;;
      --*=*)
        k=${1%%=*}; k=_O_$(echo "${k#--}" | sed -e 's/-/_/g')
        eval "$k"'=$(printf "%sX"  "${1#--*=}");' "$k=\${$k%X}"
        ;;
      --exit) return 0 ;;
      --no-?*) k=$1; shift; __parse_args "--${k#--no-}=false" "$@"; return ;;
      --?*)    k=$1; shift; __parse_args "$k=true"            "$@"; return ;;
      --) shift; __main "$@"; return $? ;;
      *)         __main "$@"; return $? ;;
    esac
  fi
  shift; __parse_args "$@"
}
__process_arg() { false; }

__main() {
local mydir; mydir=${0%/*}; cd -P "${mydir:-/}"; mydir=$PWD;
! $_O_setup_shells || setup_shells
static_sh=$(which /tmp/bbox-builtin+nofork/sh static-sh sh 2>/dev/null | head -1)
rm -rf logs; mkdir -p logs
export F8KSH_FAKESH_DATE="$_O_f8ksh_dir/util/udate +%s%N"
export F8KSH_FAKESH_DEBUG=true
#export F8KSH_FAKESH_LOGDIR="$mydir/logs"
PATH=/usr/local/bin:$PATH
CMD=kak\ -ui\ json\ -e\ \'quit\'
pwd

benchmark KAKOUNE_POSIX_SHELL="$_O_f8ksh_dir/fakesh.sh" PPATH=
benchmark KAKOUNE_POSIX_SHELL=/tmp/bbox+ln/fakesh.sh PPATH=/tmp/bbox+ln
benchmark KAKOUNE_POSIX_SHELL=/tmp/bbox+ln/fakesh.sh PPATH=
benchmark KAKOUNE_POSIX_SHELL=/tmp/bbox-builtin/fakesh.sh PPATH=
benchmark KAKOUNE_POSIX_SHELL=/tmp/bbox-builtin+nofork/fakesh.sh PPATH=
F8KSH_FAKESH_DATE='date +%s%N' \
benchmark KAKOUNE_POSIX_SHELL=/tmp/bbox-builtin/fakesh.sh PPATH= BMSFX=BBDATE
F8KSH_FAKESH_DATE='date +%s%N' \
benchmark KAKOUNE_POSIX_SHELL=/tmp/bbox-builtin+nofork/fakesh.sh PPATH= BMSFX=BBDATE

benchmark KAKOUNE_POSIX_SHELL=/tmp/bbox-builtin/binsh PPATH=
benchmark KAKOUNE_POSIX_SHELL=/tmp/bbox+ln/sh PPATH=/tmp/bbox+ln
benchmark KAKOUNE_POSIX_SHELL=/tmp/bbox+ln/sh PPATH=
benchmark KAKOUNE_POSIX_SHELL=/tmp/bbox-builtin/sh PPATH=
benchmark KAKOUNE_POSIX_SHELL=/tmp/bbox-builtin+nofork/sh PPATH=
}

__parse_args "$@"

#find logs -name 'cmdlog*.log' -not -name '*fakesh*' -exec cat {} +
#(for f in logs/*.sqlite3; do printf '\n%s\n' "$f"; sqlite3 "$f" '.mode line' 'SELECT tdelta_total / 1000000.0 as dt from cmd_stat order by dt desc limit 1'; done)
#(cd; export _kkpsh=.config/kak/plugins/plug.kak/rc/plug.sh; export code=$(cat "$_kkpsh"; echo X); code=${code%X}; cmd=' for i in $(seq 2); do plug_list; done'; cmd1='. "$_kkpsh" --'; cmd2='eval "$code"'; cmd3="eval $cmd1"; cmd4='eval "__wrap() { $code }"; __wrap'; cmd5='t=$(mktemp); echo "$code" >"$t"; . "$t"; rm -f "$t"'; hyperfine -r 50 -w 2 -S static-sh "$cmd1;$cmd" "$cmd2;$cmd" "$cmd3;$cmd" "$cmd4;$cmd" "$cmd5;$cmd")
